name: "Install dependencies"
description: "Install npm dependencies with node_modules caching"

runs:
  using: "composite"
  steps:
    - name: "ğŸ” Detect runtime versions"
      id: rt
      shell: bash
      run: |
        set -Eeuo pipefail
        echo "node=$(node -v)" >> "$GITHUB_OUTPUT"
        echo "npm=$(npm -v)"   >> "$GITHUB_OUTPUT"

    - name: "ğŸ—„ï¸ Restore node_modules"
      id: cache
      uses: actions/cache@v4
      with:
        path: node_modules
        key: nm-${{ runner.os }}-${{ steps.rt.outputs.node }}-${{ steps.rt.outputs.npm }}-${{ hashFiles('package-lock.json', 'npm-shrinkwrap.json', 'package.json') }}

    - name: "ğŸ“¦ Install"
      if: steps.cache.outputs.cache-hit != 'true'
      shell: bash
      run: |
        set -Eeuo pipefail
        if [ -f package-lock.json ]; then
          npm ci --prefer-offline --no-audit --no-fund
        else
          npm install --no-package-lock --prefer-offline --no-audit --no-fund
        fi
