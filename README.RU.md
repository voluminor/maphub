# Fantasy MapHub Generators

[Go to English version](./README.md)

## Техническая часть

### Сборка и публикация

Для сборки достаточно запустить `npm run build` что бы проект собрался полностью в папке `dist`. 

Для того что бы он стал доступен из браузера локально нужно запустить `npm run preview`.

В случае развертывании на сервере достаточно перенести в корень содержимое папки `dist`.

### Другие особенности

Данный проект собирается на основе предустановленных значений и шаблонов страниц, для внесения изменений достаточно взаимодействовать с такими файлами:

- [package.json](./package.json)
- [static.config.mjs](./static.config.mjs)
- [pages.config.mjs](./pages.config.mjs)

При необходимости можно "вырезать" только один конкретный генератор, на уровне кода они сделаны самодостаточными и не зависимыми от соседей.

Работа с данными построена на принципе proto-first, но с сохранением поддержки старых json-форматов экспорта. Если Вы планируете создавать свое решение с использованием данного генератора, рекомендую рассчитывать только на бинарные proto-файлы так как импорт/экспорт в json сфокусирован в первую очередь на поддержке старых вариантов и первоначальных watabou-генераторов. proto-файлы в свою очередь гарантируют долгосрочную поддержку даже в случае добавления нового функционала - старые сохраненные файлы будут поддерживаться и в новых версиях, без потери обратной совместимости.

Импорт работает только с расширенной версией экспорта - старые экспортированные файлы (watabou-экспорт) не откроется на редактирование в MFCG так как в файлах нет нужных полей для восстановления на редактирование.

### Формирование бинарных файлов

Все бинарные файлы формируются на основании proto-файлов которые лежат в папке: [protobuf](./protobuf)

Импорт принимает как прямые бинарные прото-обьекты из корневых структур, так и обернутые в указатель типа с CRC32.

Обертка формируется простым правилом: `|DataType uint32|{protobuf binary}|crc32IEEE({protobuf binary})`

Указатели так же в proto: [DataType](./protobuf/data/enum.proto)

Список корневых структур:

- [GeoObj](./protobuf/data/geo/obj.proto)
- [DwellingsObj](./protobuf/data/dwellings/obj.proto)
- [PaletteMfcgObj](./protobuf/data/palette/mfcg.proto)
- [PaletteVillageObj](./protobuf/data/palette/village.proto)
- [PaletteDwellingsObj](./protobuf/data/palette/dwellings.proto)
- [PaletteViewerObj](./protobuf/data/palette/viewer.proto)
- [PaletteCaveObj](./protobuf/data/palette/cave.proto)
- [PaletteGladeObj](./protobuf/data/palette/glade.proto)

## О проекте

Этот проект — объединение в один проект генераторов карт от [watabou](https://github.com/watabou/), которые он публиковал на [watabou.github.io](https://watabou.github.io). Не все из них доступны публично, а даже то, что доступно, написано на не самом популярном языке.

Я взял веб-версию с реализацией на JS и внес в неё множество изменений.

Работа ещё не завершена; Окончательная цель - получить полностью самодостаточный генератор и редактор который не требует никаких внешних ресурсов и способен в удобном формате описывать целый мир, начиная от высокого уровня (планета) и заканчивая низким (дома, поляны и пещеры)

### Что было сделано в целом:

- Эти генераторы теперь полностью локальные. То есть они могут работать без интернета: все подключения внутренние, а загружаемые файлы включены в проект.
- Реализована максимальная автоматизация. Вы можете удобно собрать всё под свой кейс, взаимодействуя только с конструкторами и JSON-параметрами.
- Создан `openapi.json` для генераторов, оно доступно напрямую через RapiDoc.
- Изменен подход к маршалингу, сделав его proto-first.
- Добавлено импорт/экспорт в бинарный файл: чистый protobuf (импорт для MFCG и Village работает только с расширенными файлами экспорта, так как стандартных недостаточно для того что бы восстановить карту на редактирование). Обратная совместимость сохранена.
- Стандартизация контекстных меню, чтобы пункты в разных генераторах находились в одних и тех же местах и имели одинаковые названия. Были переформированы группы ради максимального улучшения UI. Также добавлена функциональность для тех генераторов, у которых её не было (`Permalink...`, `Fullscreen`).
- Добавлена возможность открывать города и деревни прямо в 3D-просмотрщике (`View in 3D`).
- Диалоги сделаны более дружелюбными (например, теперь явно сообщается, в чём проблема при импорте). Так же добавлены прелоадеры для тяжелых операций по типу экспорта PNG.
- Появились префиксы для экспортируемых файлов (`*.palette.mf.json`, `*.mf.json`), чтобы было понятно, что к чему относится, не заглядывая внутрь.
- Исправлено множество мелких багов для краевых условий.
- Добавлен новый функционал (обработка колесика мышки в MFCG и Dwellings, а так же сложная линейка для MFCG)
- Опубликовано это как отдельный [веб-ресурс](https://maphub.webtools.download), включая [PWA](https://en.wikipedia.org/wiki/Progressive_web_app), что позволяет установить его как приложение, которому не нужен интернет.

### Планы на будущее:

- ~~Перенести импорт/экспорт палитр в proto.~~
- Добавить экспорт для Cave/Glade Generator.
- ~~Добавить возможность импортировать схемы из файла для всех генераторов, кроме City Viewer (поскольку у City Viewer уже есть импорт).~~
- Добавить 3D-визуализатор для зданий (отдельный или просто расширить функциональность City Viewer).
- ~~Добавить расширенный режим экспорта, который переносит имена, подписи и другие поля.~~
- Добавить генерацию указателей Cave/Glade в Medieval-Fantasy-City/Village Generator.
- После расширенного экспорта станет возможно связать Cave/Glade/Dwellings Generator и Medieval-Fantasy-City/Village Generator.
- Сделать отдельно собираемым или расширить текущую сборку списком сохранённых карт и палитр прямо в приложении.

## Галерея

### Все контекстные меню одной картинкой

![all\-menu](.github/img/all-menu.png)

### Как изменилось контекстное меню

#### Cave/Glade Generator

![to\_cave](.github/img/to_cave.png)

#### Dwellings Generator

![to\_dwellings](.github/img/to_dwellings.png)

#### Village Generator

![to\_village](.github/img/to_village.png)

#### Medieval-Fantasy-City Generator

![to\_mfcg](.github/img/to_mfcg.png)

#### City Viewer

![to\_viewer](.github/img/to_viewer.png)

### Пример установленного приложения

#### Установлено на телефон: отдельная иконка, работает даже без интернета

![to\_village](.github/img/mob_app.jpg)

#### Пример работы без интернета

![to\_village](.github/img/mob_city.jpg)

## CONTRIBUTING

Если вы хотите присоединиться или просто исправить баг — отправьте pull request с описанием.

## LICENSE

Исходный код опубликован под MPL-2.0.

Контактный email: [mail@sunsung.fun](mailto:mail@sunsung.fun).
